# Cloud Build Pipeline Documentation

## Overview

This document describes the multi-stage Cloud Build pipeline for roadtrip.ai that automatically builds, tests, and deploys the entire application to both development and production environments.

## Pipeline Architecture

The pipeline consists of 7 main stages:

1. **Build and Test Backend** - Compiles and tests the Spring Boot application
2. **Build Frontend** - Builds the React frontend application
3. **Push Images** - Pushes Docker images to Google Container Registry
4. **Deploy to Dev** - Deploys to development environment with H2 database
5. **Dev Environment Tests** - Validates the development deployment
6. **Deploy to Prod** - Deploys to production environment with PostgreSQL
7. **Final Prod Tests** - Validates the production deployment

## Environment Configuration

### Development Environment
- **Backend Service**: `roadtrip-ai-backend-dev`
- **Frontend Service**: `roadtrip-ai-frontend-dev`
- **Database**: H2 in-memory database
- **Profile**: `dev`
- **Resources**: 2Gi memory, 2 CPU, max 5 instances

### Production Environment
- **Backend Service**: `roadtrip-ai-backend`
- **Frontend Service**: `roadtrip-ai-frontend`
- **Database**: PostgreSQL (Cloud SQL)
- **Profile**: `prod`
- **Resources**: 2Gi memory, 2 CPU, max 10 instances

## Prerequisites

### 1. Enable Required APIs

```bash
# Enable required Google Cloud APIs
gcloud services enable cloudbuild.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable containerregistry.googleapis.com
```

### 2. Set Up Secrets

Run the setup script to create all required secrets:

```bash
./setup-secrets.sh
```

This will create the following secrets in Google Secret Manager:
- `jwt-secret` - JWT signing secret
- `db-url` - PostgreSQL database URL
- `db-username` - Database username
- `db-password` - Database password
- `openai-api-key` - OpenAI API key

### 3. Grant Cloud Build Permissions

```bash
# Grant Cloud Build service account necessary permissions
PROJECT_ID=$(gcloud config get-value project)
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format='value(projectNumber)')

# Grant Cloud Run Admin role
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
    --role="roles/run.admin"

# Grant IAM Service Account User role
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
    --role="roles/iam.serviceAccountUser"

# Grant Secret Manager Secret Accessor role
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor"
```

## Pipeline Configuration

### Build Triggers

The pipeline is triggered automatically on:
- Push to `main` branch
- Pull request to `main` branch
- Manual trigger from Cloud Console

### Build Steps

#### Stage 1: Build and Test Backend
```yaml
- Builds Docker image for backend
- Runs unit tests with H2 database
- Uses Gradle for build process
```

#### Stage 2: Build Frontend
```yaml
- Builds Docker image for frontend
- Uses Node.js 20 Alpine
- Builds production-ready React app
```

#### Stage 3: Push Images
```yaml
- Pushes both images to Google Container Registry
- Tags with commit SHA and 'latest'
```

#### Stage 4: Deploy to Dev
```yaml
- Deploys backend with H2 database
- Deploys frontend with dev environment variables
- Sets up service URLs automatically
```

#### Stage 5: Dev Environment Tests
```yaml
- Tests backend health endpoint
- Tests frontend accessibility
- Validates service communication
```

#### Stage 6: Deploy to Prod
```yaml
- Deploys backend with PostgreSQL
- Deploys frontend with production settings
- Uses secrets for sensitive configuration
```

#### Stage 7: Final Prod Tests
```yaml
- Validates production deployment
- Tests all endpoints
- Confirms successful deployment
```

## Environment Variables

### Development Environment Variables

#### Backend (Dev)
```bash
SPRING_PROFILES_ACTIVE=dev
DATABASE_URL=jdbc:h2:mem:testdb
DATABASE_USERNAME=sa
DATABASE_PASSWORD=
LOG_LEVEL=DEBUG
JWT_SECRET=<from-secret>
OPENAI_API_KEY=<from-secret>
```

#### Frontend (Dev)
```bash
VITE_APP_ENV=development
VITE_API_BASE_URL=<auto-generated-backend-url>
```

### Production Environment Variables

#### Backend (Prod)
```bash
SPRING_PROFILES_ACTIVE=prod
LOG_LEVEL=INFO
DATABASE_URL=<from-secret>
DATABASE_USERNAME=<from-secret>
DATABASE_PASSWORD=<from-secret>
JWT_SECRET=<from-secret>
OPENAI_API_KEY=<from-secret>
```

#### Frontend (Prod)
```bash
VITE_APP_ENV=production
VITE_API_BASE_URL=<auto-generated-backend-url>
```

## Monitoring and Troubleshooting

### View Build Logs

```bash
# List recent builds
gcloud builds list --limit=10

# View specific build
gcloud builds log BUILD_ID

# Stream build logs in real-time
gcloud builds log --stream
```

### Monitor Services

```bash
# List Cloud Run services
gcloud run services list --region=australia-southeast1

# View service logs
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=roadtrip-ai-backend" --limit=50

# Check service status
gcloud run services describe roadtrip-ai-backend --region=australia-southeast1
```

### Common Issues and Solutions

#### 1. Build Failures
- **Issue**: Docker build fails
- **Solution**: Check Dockerfile syntax and dependencies

#### 2. Test Failures
- **Issue**: Backend tests fail
- **Solution**: Run tests locally first, check test configuration

#### 3. Deployment Failures
- **Issue**: Cloud Run deployment fails
- **Solution**: Check service account permissions and resource limits

#### 4. Secret Access Issues
- **Issue**: Cannot access secrets
- **Solution**: Verify Cloud Build service account has Secret Manager access

#### 5. Database Connection Issues
- **Issue**: Cannot connect to database
- **Solution**: Check database URL, credentials, and network connectivity

## Security Considerations

### Secrets Management
- All sensitive data is stored in Google Secret Manager
- Secrets are automatically rotated and versioned
- Access is restricted to Cloud Build service account

### Network Security
- Services run in isolated Cloud Run environments
- HTTPS is enforced for all external communication
- CORS is configured appropriately for each environment

### Access Control
- Cloud Build service account has minimal required permissions
- Production secrets are separate from development
- Audit logging is enabled for all operations

## Performance Optimization

### Build Optimization
- Uses Docker layer caching
- Parallel builds where possible
- Optimized base images (Alpine Linux)

### Runtime Optimization
- Production uses connection pooling
- Caching is enabled for production
- Resource limits are set appropriately

## Rollback Strategy

### Automatic Rollback
- If any stage fails, the pipeline stops
- Previous successful deployment remains active
- No partial deployments occur

### Manual Rollback
```bash
# Rollback to previous version
gcloud run services update-traffic roadtrip-ai-backend \
    --to-revisions=roadtrip-ai-backend-00001-abc=100 \
    --region=australia-southeast1
```

## Cost Optimization

### Development Environment
- Lower resource limits (2Gi memory, 2 CPU)
- Fewer max instances (5)
- H2 database (no additional cost)

### Production Environment
- Higher resource limits for performance
- More max instances (10) for scalability
- PostgreSQL database (additional cost)

### Build Optimization
- Efficient Docker images reduce storage costs
- Parallel builds reduce compute time
- Caching reduces repeated work

## Next Steps

1. **Set up monitoring alerts** for build failures and service health
2. **Configure custom domains** for production services
3. **Set up automated testing** for pull requests
4. **Implement blue-green deployments** for zero-downtime updates
5. **Add performance monitoring** and alerting 